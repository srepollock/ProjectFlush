var canvas=document.getElementById("canGame"),context=canvas.getContext("2d");canvas.addEventListener("mousedown",doMouseDown,!0);document.onkeydown=doKeyDown;var moveSound=new Audio;moveSound.src="./sound/move.wav";var badMoveSound=new Audio;badMoveSound.src="./sound/badMoveSound.wav";var levelComplete=new Audio;levelComplete.src="./sound/levelComplete.mp3";var gameOverSound=new Audio;gameOverSound.src="./sound/gameOverSound.wav";var wallSound=new Audio;wallSound.src="./sound/wall.wav";
var achievementSound=new Audio;achievementSound.src="./sound/achievement.wav";var SCREENWIDTH=canvas.width,SCREENHEIGHT=canvas.height,map,distanceMap,wall=new Image;wall.src="./pics/wall.png";var floor=new Image;floor.src="./pics/floor.png";var path=new Image;path.src="./pics/path.png";var character=new Image;character.src="./pics/character.png";var gameOverGraphic=new Image;gameOverGraphic.src="./pics/gameOver.png";var leftArrowGraphic=new Image;leftArrowGraphic.src="./pics/arrowLeft.png";
var rightArrowGraphic=new Image;rightArrowGraphic.src="./pics/arrowRight.png";var upArrowGraphic=new Image;upArrowGraphic.src="./pics/arrowUp.png";var downArrowGraphic=new Image;downArrowGraphic.src="./pics/arrowDown.png";var fingerGraphic=new Image;fingerGraphic.src="./pics/finger.png";var toiletGraphic=new Image;toiletGraphic.src="./pics/toilet.png";var darkSquareGraphic=new Image;darkSquareGraphic.src="./pics/darkSquare.png";var menuScreenGraphic=new Image;menuScreenGraphic.src="./pics/pic2.png";
var playButtonGraphic=new Image;playButtonGraphic.src="./pics/PlayButton.png";var hintButtonGraphic=new Image;hintButtonGraphic.src="./pics/hintButton.png";var lowerBackgroundGraphic=new Image;lowerBackgroundGraphic.src="./pics/lowerBackground.png";var speakerGraphic=new Image;speakerGraphic.src="./pics/speaker.png";var mutedGraphic=new Image;mutedGraphic.src="./pics/crossSpeaker.png";var windowGraphic=new Image;windowGraphic.src="./pics/messageWindow.png";var pauseGraphic=new Image;
pauseGraphic.src="./pics/pause.png";var pausedTextGraphic=new Image;pausedTextGraphic.src="./pics/paused.png";var achievementsWindowGraphic=new Image;achievementsWindowGraphic.src="./pics/achievementsWindow.png";var checkMarkGraphic=new Image;checkMarkGraphic.src="./pics/checkMark.png";var trophyGraphic=new Image;trophyGraphic.src="./pics/achievement.png";
var imgSize=16,fingerGraphicDown=!1,hintButtonX=.82*canvas.width,hintButtonY=canvas.height-30,hintCost=20,muteButtonX=.9*canvas.width,muteButtonY=10,isMuted=!1,solutionVisible=!0,limitedSight=!0,showDistances=!1,initialWidth=10,initialHeight=10,width=initialWidth,height=initialHeight,offsetx,offsety,targetx,targety,startx=1,starty=1,playerPositionx,playerPositiony,gameLevel=1,score=0,timerVar=setInterval(function(){timerFunction()},1E3),timeLeft=0,startingGameTime=180,bonusTimer=100,showMapPause=
0,isMenuScreen=!0,isGameScreen=!1,isGameOver=!1,controlVisualVisible=!0,isAchievementMenu=!1,userBrowser="Unknown",firstLevelAchievement=!1,firstPlayAchievement=!1,firstHintAchievement=!1,fifthLevelAchievement=!1,movementKeyArray=[33,34,35,36,37,38,39,40],messages=Array(4),isShowingMessage=!1,isPaused=!1,nameInput=!1;
function pageLoaded(){checkBrowser();loadCookie();$(document).keydown(function(a){return-1<$.inArray(a.which,movementKeyArray)?(a.preventDefault(),!1):!0});context.fillStyle="#41ADFF";context.fillRect(0,0,canvas.width,canvas.height);context.drawImage(menuScreenGraphic,canvas.width/2-menuScreenGraphic.width/2,0);context.drawImage(playButtonGraphic,canvas.width/2-playButtonGraphic.width/2,.75*canvas.height)}
function startGame(){isGameScreen=!0;isMenuScreen=!1;gameLevel=1;score=0;timeLeft=startingGameTime;bonusTimer=100;width=initialHeight;height=initialWidth;drawGraphics();generateMap();randomizeExit();doPathfinding();solutionVisible=!0;limitedSight=!1;drawMaze();isGameOver=!1}
function drawGraphics(){playerPositionx=startx;playerPositiony=starty;map=Array(width);distanceMap=Array(width);for(var a=0;a<width;a++)map[a]=Array(height),distanceMap[a]=Array(height);for(var b=0;b<height;b++)for(a=0;a<width;a++)map[a][b]=".",distanceMap[a][b]=-1;drawMaze()}function generateMap(){drawSpot(1,1,Math.floor(4*Math.random()));drawMaze()}function doPathfinding(){findPath(startx,starty,1);finalPath(targetx,targety);drawMaze()}
function drawMaze(){offsetx=canvas.width/2-width*imgSize/2;offsety=canvas.height/2-height*imgSize/2;context.fillStyle="#D1FFF0";context.fillRect(0,0,canvas.width,canvas.height);context.fillStyle="#000000";for(var a=0;a<height;a++)for(var b=0;b<width;b++)!limitedSight||b>=playerPositionx-1&&b<=playerPositionx+1&&a>=playerPositiony-1&&a<=playerPositiony+1&&!isPaused?("."==map[b][a]?context.drawImage(wall,offsetx+b*imgSize,offsety+a*imgSize,imgSize,imgSize):"P"==map[b][a]&&solutionVisible?context.drawImage(path,
offsetx+b*imgSize,offsety+a*imgSize,imgSize,imgSize):context.drawImage(floor,offsetx+b*imgSize,offsety+a*imgSize,imgSize,imgSize),b==playerPositionx&&a==playerPositiony&&context.drawImage(character,offsetx+b*imgSize,offsety+a*imgSize,imgSize,imgSize),b==targetx&&a==targety&&context.drawImage(toiletGraphic,offsetx+b*imgSize,offsety+a*imgSize,imgSize,imgSize),showDistances&&context.fillText(distanceMap[b][a],offsetx+b*imgSize,offsety+(a+1)*imgSize)):context.drawImage(darkSquareGraphic,offsetx+b*imgSize,
offsety+a*imgSize,imgSize,imgSize),isPaused&&context.drawImage(pausedTextGraphic,canvas.width/2-pausedTextGraphic.width/2,canvas.height/2-pausedTextGraphic.height/2),context.drawImage(lowerBackgroundGraphic,0,canvas.height-40,canvas.width,40),context.drawImage(hintButtonGraphic,hintButtonX,hintButtonY,50,20),isMuted?context.drawImage(mutedGraphic,muteButtonX,muteButtonY):context.drawImage(speakerGraphic,muteButtonX,muteButtonY),context.drawImage(trophyGraphic,muteButtonX-20,muteButtonY),context.drawImage(pauseGraphic,
muteButtonX-40,muteButtonY),1==gameLevel&&(context.drawImage(leftArrowGraphic,10,canvas.height/2-leftArrowGraphic.height/2),context.drawImage(rightArrowGraphic,canvas.width-10-rightArrowGraphic.width,canvas.height/2-rightArrowGraphic.height/2),context.drawImage(upArrowGraphic,canvas.width/2-upArrowGraphic.width/2,10),context.drawImage(downArrowGraphic,canvas.width/2-downArrowGraphic.width/2,canvas.height-40-downArrowGraphic.height)),controlVisualVisible&&(context.font="17px Arial",context.fillText("Memorize this path to the toilet",
offsetx-32,offsety-12),context.fillText("Then retrace it as fast as you can!",offsetx-50,offsety+width*imgSize+16),fingerGraphicDown?context.drawImage(fingerGraphic,canvas.width-10-rightArrowGraphic.width,canvas.height/2-rightArrowGraphic.height/2):context.drawImage(fingerGraphic,canvas.width-10-rightArrowGraphic.width,canvas.height/2-rightArrowGraphic.height/2-20)),isAchievementMenu&&(context.drawImage(achievementsWindowGraphic,canvas.width/2-achievementsWindowGraphic.width/2,canvas.height/2-achievementsWindowGraphic.height/
2),firstPlayAchievement&&context.drawImage(checkMarkGraphic,canvas.width/2-achievementsWindowGraphic.width/2+20,canvas.height/2-achievementsWindowGraphic.height/2+44),firstLevelAchievement&&context.drawImage(checkMarkGraphic,canvas.width/2-achievementsWindowGraphic.width/2+20,canvas.height/2-achievementsWindowGraphic.height/2+74),firstHintAchievement&&context.drawImage(checkMarkGraphic,canvas.width/2-achievementsWindowGraphic.width/2+20,canvas.height/2-achievementsWindowGraphic.height/2+104),fifthLevelAchievement&&
context.drawImage(checkMarkGraphic,canvas.width/2-achievementsWindowGraphic.width/2+20,canvas.height/2-achievementsWindowGraphic.height/2+136)),isShowingMessage&&displayAchievement();testingOutput()}function checkSpot(a,b,c,d){if("#"==map[a][b]||0===a||0===b||a==width-1||b==height-1)return!1;for(var e=b-1;e<=b+1;e++)for(var f=a-1;f<=a+1;f++)if(f!=c&&e!=d&&"#"==map[f][e])return!1;return!0}
function drawSpot(a,b,c){var d;map[a][b]="#";d=Math.floor(2*Math.random());c=1==Math.floor(2*Math.random())?Math.floor(4*Math.random()):c;for(var e=0;4>e;e++){switch(c){case 0:checkSpot(a,b-1,a,b)&&drawSpot(a,b-1,c);break;case 1:checkSpot(a,b+1,a,b)&&drawSpot(a,b+1,c);break;case 2:checkSpot(a-1,b,a,b)&&drawSpot(a-1,b,c);break;case 3:checkSpot(a+1,b,a,b)&&drawSpot(a+1,b,c)}d?(c--,0>c&&(c=3)):(c++,3<c&&(c=0))}}
function findPath(a,b,c){map[a][b]="P";distanceMap[a][b]=c;c++;for(var d=0;4>d;d++)switch(d){case 0:("#"==map[a-1][b]||distanceMap[a-1][b]>c-1&&0<=distanceMap[a-1][b])&&findPath(a-1,b,c);break;case 1:("#"==map[a+1][b]||distanceMap[a+1][b]>c-1&&0<=distanceMap[a+1][b])&&findPath(a+1,b,c);break;case 2:("#"==map[a][b-1]||distanceMap[a][b-1]>c-1&&0<=distanceMap[a][b-1])&&findPath(a,b-1,c);break;case 3:("#"==map[a][b+1]||distanceMap[a][b+1]>c-1&&0<=distanceMap[a][b+1])&&findPath(a,b+1,c)}map[a][b]="C"}
function finalPath(a,b){var c,d,e;if(a==startx&&b==starty)return map[a][b]="P",!0;for(var f=0;4>f;f++){switch(f){case 0:c=parseInt(a)-1;d=b;break;case 1:c=parseInt(a)+1;d=b;break;case 2:c=a;d=parseInt(b)-1;break;case 3:c=a,d=parseInt(b)+1}if(0<distanceMap[c][d]&&distanceMap[c][d]<distanceMap[a][b]&&(e=finalPath(parseInt(c),parseInt(d)),!0===e))return map[a][b]="P",!0}return!1}
function solutionVisibility(){solutionVisible?(solutionVisible=!1,limitedSight=!0):(solutionVisible=!0,limitedSight=!1);drawMaze()}
function doMouseDown(a){var b=a.pageX-canvas.offsetLeft;a=a.pageY-canvas.offsetTop;isShowingMessage?(isShowingMessage=!1,drawMaze()):isAchievementMenu?(isPaused=isAchievementMenu=!1,drawMaze()):isMenuScreen?(startGame(),isMenuScreen=!1,0==firstPlayAchievement&&gainAchievement(1)):(controlVisualVisible=!1,isGameOver||0!=showMapPause||buttonPressed(b,a)||isPaused||(solutionVisible&&solutionVisibility(),b>SCREENWIDTH/2&&a>SCREENHEIGHT/2-(b-SCREENWIDTH/2)&&a<SCREENHEIGHT/2+(b-SCREENWIDTH/2)?moveRight():
b<SCREENWIDTH/2&&a>SCREENHEIGHT/2-(SCREENWIDTH/2-b)&&a<SCREENHEIGHT/2+(SCREENWIDTH/2-b)?moveLeft():a>SCREENHEIGHT/2?moveDown():a<SCREENHEIGHT/2&&moveUp()))}
function moveDown(){"."!=map[playerPositionx][playerPositiony+1]?("P"==map[playerPositionx][playerPositiony+1]?("Unknown"!=userBrowser&&(moveSound.currentTime=0),isMuted||moveSound.play()):isMuted||badMoveSound.play(),playerPositiony++,onPath()||(playerPositionx=startx,playerPositiony=starty)):(wallSound.currentTime=0,isMuted||wallSound.play());checkForExit();drawMaze()}
function moveUp(){"."!=map[playerPositionx][playerPositiony-1]?("P"==map[playerPositionx][playerPositiony-1]?("Unknown"!=userBrowser&&(moveSound.currentTime=0),isMuted||moveSound.play()):isMuted||badMoveSound.play(),playerPositiony--,onPath()||(playerPositionx=startx,playerPositiony=starty)):(wallSound.currentTime=0,isMuted||wallSound.play());checkForExit();drawMaze()}
function moveRight(){"."!=map[playerPositionx+1][playerPositiony]?("P"==map[playerPositionx+1][playerPositiony]?("Unknown"!=userBrowser&&(moveSound.currentTime=0),isMuted||moveSound.play()):isMuted||badMoveSound.play(),playerPositionx++,onPath()||(playerPositionx=startx,playerPositiony=starty)):(wallSound.currentTime=0,isMuted||wallSound.play());checkForExit();drawMaze()}
function moveLeft(){"."!=map[playerPositionx-1][playerPositiony]?("P"==map[playerPositionx-1][playerPositiony]?("Unknown"!=userBrowser&&(moveSound.currentTime=0),isMuted||moveSound.play()):isMuted||badMoveSound.play(),playerPositionx--,onPath()||(playerPositionx=startx,playerPositiony=starty)):(wallSound.currentTime=0,isMuted||wallSound.play());checkForExit();drawMaze()}
function checkForExit(){playerPositionx==targetx&&playerPositiony==targety&&(isMuted||levelComplete.play(),score+=100+bonusTimer,1==gameLevel&&0==firstLevelAchievement&&gainAchievement(0),5==gameLevel&&0==fifthLevelAchievement&&gainAchievement(3),gameLevel++,24>=parseInt(width)+2&&24>=parseInt(height)+2&&0==gameLevel%2&&(width+=2,height+=2,70>canvas.width-imgSize*width&&(imgSize=(canvas.width-70)/width)),showMapPause=2,drawGraphics(),generateMap(),randomizeExit(),doPathfinding(),solutionVisibility(),
testingOutput())}function testingOutput(){context.font="17px Arial";context.fillText("Level: "+gameLevel+"  Score: "+score+"  Time: "+timeLeft,10,canvas.height-20)}
function randomizeExit(){targetx=Math.floor(Math.random()*(width/2))+width/2-1;targety=Math.floor(Math.random()*(height/2))+height/2-1;if("."==map[targetx][targety]){for(var a=0;4>a;a++)switch(a){case 0:if("."!=map[targetx+1][targety]){targetx+=1;return}break;case 1:if("."!=map[targetx-1][targety]){--targetx;return}break;case 2:if("."!=map[targetx][targety+1]){targety+=1;return}break;case 3:if("."!=map[targetx][targety-1]){--targety;return}}randomizeExit()}}
function onPath(){return"P"==map[playerPositionx][playerPositiony]}function timerFunction(){fingerGraphicDown=!fingerGraphicDown;0<showMapPause&&showMapPause--;isGameScreen&&(0<timeLeft?(controlVisualVisible||isShowingMessage||isPaused||(timeLeft--,0<bonusTimer&&bonusTimer--),drawMaze()):isGameOver||(isMuted||gameOverSound.play(),isGameOver=!0,drawGameOver(),nameInput=!0,sendphp()))}
function drawGameOver(){context.clearRect(0,0,canvas.width,canvas.height);context.drawImage(gameOverGraphic,canvas.width/2-82,canvas.width/2-154);testingOutput()}
function sendphp(){if(nameInput){var a=prompt("Enter your name:","Player");if(null!=a){var b;b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");b.open("POST","leader.php",!0);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send("name="+a+"&score="+score+"&level="+gameLevel)}setTimeout(function(){location.href="./leader.php"},500);nameInput=!1}}
(function(a){a.fn.nodoubletapzoom=function(){a(this).bind("touchstart",function(b){var c=b.timeStamp,d=a(this).data("lastTouch")||c,d=c-d,e=b.originalEvent.touches.length;a(this).data("lastTouch",c);!d||500<d||1<e||(b.preventDefault(),a(this).trigger("click").trigger("click"))})}})(jQuery);function checkBrowser(){var a=navigator.userAgent;-1!=a.indexOf("Firefox")&&(userBrowser="Firefox");-1!=a.indexOf("Chrome")&&(userBrowser="Chrome");-1!=a.indexOf("Safari")&&(userBrowser="Safari")}
function loadCookie(){var a=document.cookie;""==a&&saveCookie();-1!=a.indexOf("firstLevelAchievement=true")&&(firstLevelAchievement=!0);-1!=a.indexOf("firstPlayAchievement=true")&&(firstPlayAchievement=!0);-1!=a.indexOf("firstHintAchievement=true")&&(firstHintAchievement=!0);-1!=a.indexOf("fifthLevelAchievement=true")&&(fifthLevelAchievement=!0)}
function saveCookie(){var a=new Date;a.setMinutes(a.getMinutes()+2);document.cookie="firstLevelAchievement="+firstLevelAchievement+"; expires="+a.toGMTString();document.cookie="firstPlayAchievement="+firstPlayAchievement+"; expires="+a.toGMTString();document.cookie="firstHintAchievement= "+firstHintAchievement+"; expires="+a.toGMTString();document.cookie="fifthLevelAchievement= "+fifthLevelAchievement+"; expires="+a.toGMTString()}
function gainAchievement(a){switch(a){case 0:firstLevelAchievement=!0;drawMaze();messages[0]="     First level";messages[1]="   achievement";messages[2]="     unlocked!";isShowingMessage=!0;isMuted||achievementSound.play();drawMaze();saveCookie();break;case 1:firstPlayAchievement=!0;drawMaze();messages[0]="     First play";messages[1]="   achievement";messages[2]="     unlocked!";isShowingMessage=!0;isMuted||achievementSound.play();drawMaze();saveCookie();break;case 2:firstHintAchievement=!0;drawMaze();
messages[0]="     First hint";messages[1]="   achievement";messages[2]="     unlocked!";isShowingMessage=!0;isMuted||achievementSound.play();drawMaze();saveCookie();break;case 3:fifthLevelAchievement=!0,drawMaze(),messages[0]="     Fifth level",messages[1]="   achievement",messages[2]="     unlocked!",isShowingMessage=!0,isMuted||achievementSound.play(),drawMaze(),saveCookie()}}
function doKeyDown(a){isMenuScreen?(startGame(),isMenuScreen=!1):(controlVisualVisible=!1,isGameOver||0!=showMapPause||isShowingMessage||isPaused||(solutionVisible&&solutionVisibility(),a=a||window.event,"38"==a.keyCode?moveUp():"40"==a.keyCode?moveDown():"37"==a.keyCode?moveLeft():"39"==a.keyCode&&moveRight()))}
function buttonPressed(a,b){if(a>hintButtonX&&a<hintButtonX+hintButtonGraphic.width&&b>hintButtonY&&b<hintButtonY+hintButtonGraphic.height&&!isPaused)return!solutionVisible&&limitedSight&&(solutionVisible=!0,limitedSight=!1,0==firstHintAchievement&&gainAchievement(2),timeLeft=0>timeLeft-hintCost?0:timeLeft-hintCost,drawMaze()),!0;if(a>muteButtonX&&a<muteButtonX+speakerGraphic.width&&b>muteButtonY&&b<muteButtonY+speakerGraphic.height)return isMuted=!isMuted,drawMaze(),!0;if(a>muteButtonX-20&&a<muteButtonX+
trophyGraphic.width&&b>muteButtonY&&b<muteButtonY+trophyGraphic.height)return isAchievementMenu=isPaused=!0,drawMaze(),!0;if(a>muteButtonX-40&&a<muteButtonX+pauseGraphic.width&&b>muteButtonY&&b<muteButtonY+pauseGraphic.height)return isPaused=!isPaused,limitedSight=!0,solutionVisible=!1,drawMaze(),!0}
function displayAchievement(){context.drawImage(windowGraphic,canvas.width/2-windowGraphic.width/2,canvas.height/2-windowGraphic.height/2);for(var a=0;4>a;a++)void 0!=messages[a]&&context.fillText(messages[a],canvas.width/2-windowGraphic.width/2+12,canvas.height/2-windowGraphic.height/2+50+20*a)};